<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <title>MF.AI ‚Äî Clienti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    .muted{color:#666}
    table pre{margin:0}
    dialog{max-width:520px}
    .feedback{margin-top:.5rem;font-size:.9rem;color:#666}
    .feedback.ok{color:#1b8a5a}
    .feedback.err{color:#c0392b}
  </style>
</head>
<body class="container">
  <header>
    <h2>MF.AI ‚Äî Clienti</h2>
    <p class="muted">Clicca su un cliente per aprire la sua scheda.</p>
    <nav>
      <a href="/ui" role="button" class="secondary">‚Üê Home Admin</a>
      <a href="/ui/prompts-ui" role="button">Prompts</a>
      <!-- üîò Nuovo: bottone per aggiungere clienti -->
      <button id="btn-open-new" class="contrast" style="margin-left:.5rem">+ Nuovo cliente</button>
    </nav>
  </header>

  <main>
    <article>
      <div id="list">Caricamento‚Ä¶</div>
      <!-- ===== Spazio: Risposte DM post (inline) ===== -->
<article id="dm-replies-panel" style="margin-top:16px;">
  <h3>Risposte DM post</h3>
  <p class="muted" style="margin-top:-6px">
    Inserisci l‚Äô<b>ID cliente</b> (o falla riempire in automatico pi√π avanti), poi salva un
    <em>default</em> o una risposta per <em>singolo post</em> (Media ID).
  </p>

  <!-- Form: Aggiungi/Aggiorna -->
  <form action="/ui2/dm-replies/inline/save" method="post" style="margin:0 0 12px;">
    <div class="grid">
      <div>
        <label>Client ID</label>
        <input type="number" name="client_id" id="dm-client-id" placeholder="Es. 125" required>
      </div>
      <div>
        <label>Media ID (vuoto = default cliente)</label>
        <input type="text" name="media_id" id="dm-media-id" placeholder="17912345678901234">
        <small class="muted">Se lasci vuoto aggiorni <code>ig_private_reply_default</code></small>
      </div>
      <div>
        <label>Messaggio DM</label>
        <textarea name="message" id="dm-message" rows="3" placeholder="Es. Grazie del commento, ti scrivo in DM."></textarea>
      </div>
    </div>
    <button type="submit">Salva</button>
  </form>

  <!-- Tabella risposte esistenti -->
  <details>
    <summary>Risposte salvate (default e per-post)</summary>
    <div id="dm-replies-table" style="overflow:auto">
      <!-- verr√† riempito via JS -->
      <table>
        <thead>
          <tr><th>Key</th><th>Messaggio</th><th style="width:1%"></th></tr>
        </thead>
        <tbody id="dm-replies-tbody">
          <tr><td colspan="3" class="muted">Seleziona ID cliente e premi ‚ÄúCarica‚Äù.</td></tr>
        </tbody>
      </table>
    </div>
    <div class="grid" style="margin-top:.5rem">
      <button type="button" id="dm-load">Carica</button>
      <span class="muted">Mostra le voci in <code>mfai_app.client_prompts</code> per questo cliente.</span>
    </div>
  </details>
</article>
<!-- ===== /Spazio: Risposte DM post ===== -->

<script>
  // Mini helper per caricare/eliminare righe (usa gli endpoint gi√† suggeriti in routes.py)
  async function fetchJSON(url, opts){ const r = await fetch(url, opts||{}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json().catch(()=>({})) }

  // ENDPOINT minimo di lettura: crea un GET in routes.py se non l'hai gi√† (vedi nota sotto)
  async function loadDmReplies(clientId){
    const tbody = document.getElementById('dm-replies-tbody');
    tbody.innerHTML = '<tr><td colspan="3" class="muted">Caricamento‚Ä¶</td></tr>';
    try{
      const res = await fetch(`/admin/client_prompts?client_id=${clientId}`); // vedi nota sotto
      if(!res.ok){ tbody.innerHTML = '<tr><td colspan="3" class="muted">Errore caricamento.</td></tr>'; return; }
      const rows = await res.json(); // atteso: [{key:"ig_private_reply_default", value:"..."}, ...]
      const onlyDm = rows.filter(r => r.key === 'ig_private_reply_default' || r.key.startsWith('ig_private_reply:'));
      if(onlyDm.length === 0){
        tbody.innerHTML = '<tr><td colspan="3" class="muted">Nessuna risposta salvata.</td></tr>';
        return;
      }
      tbody.innerHTML = onlyDm.map(r => `
        <tr>
          <td><code>${r.key}</code></td>
          <td style="white-space:pre-wrap">${r.value||''}</td>
          <td>
            <form action="/ui2/dm-replies/inline/delete" method="post">
              <input type="hidden" name="client_id" value="${clientId}">
              <input type="hidden" name="key" value="${r.key}">
              <button type="submit" class="secondary">Elimina</button>
            </form>
          </td>
        </tr>
      `).join('');
    }catch(e){
      tbody.innerHTML = '<tr><td colspan="3" class="muted">Errore.</td></tr>';
    }
  }

  // Pulsante "Carica"
  document.getElementById('dm-load')?.addEventListener('click', ()=>{
    const cid = document.getElementById('dm-client-id').value.trim();
    if(cid) loadDmReplies(cid);
  });

  // (Opzionale) funzione che clients.js pu√≤ chiamare quando clicchi un cliente
  window.setSelectedClientForDmReplies = function(clientId){
    document.getElementById('dm-client-id').value = clientId;
    try{ loadDmReplies(clientId); }catch{}
  };
</script>

    </article>
  </main>

  <!-- Modale: Nuovo cliente -->
  <dialog id="dlg-new">
    <article>
      <header>
        <strong>Crea nuovo cliente</strong>
      </header>
      <form id="form-new">
        <label>
          Nome <span style="color:#c00">*</span>
          <input type="text" id="nc-name" name="name" placeholder="Es. Acme srl" required>
        </label>

        <label>
          Email
          <input type="email" id="nc-email" name="email" placeholder="contatti@azienda.it">
        </label>

        <p id="nc-feedback" class="feedback" aria-live="polite"></p>

        <footer style="display:flex;justify-content:flex-end;gap:.5rem">
          <button type="button" class="secondary" id="btn-cancel">Annulla</button>
          <button type="submit">Crea</button>
        </footer>
      </form>
    </article>
  </dialog>

  <script src="/static/clients.js"></script>
  <script>
    (function(){
      const dlg = document.getElementById('dlg-new');
      const openBtn = document.getElementById('btn-open-new');
      const cancelBtn = document.getElementById('btn-cancel');
      const form = document.getElementById('form-new');
      const fb = document.getElementById('nc-feedback');
      const nameEl = document.getElementById('nc-name');
      const emailEl = document.getElementById('nc-email');

      function openDialog(){
        fb.textContent = ''; fb.className = 'feedback';
        form.reset();
        dlg.showModal();
        nameEl.focus();
      }
      function closeDialog(){
        dlg.close();
      }

      async function postJSON(url, data){
        const res = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          credentials: 'include',
          body: JSON.stringify(data)
        });
        if(!res.ok){
          let msg = 'Errore';
          try { const j = await res.json(); msg = j.error || msg; } catch {}
          throw new Error(msg + ' (HTTP ' + res.status + ')');
        }
        return res.json();
      }

      async function onSubmit(ev){
        ev.preventDefault();
        const name = nameEl.value.trim();
        const email = emailEl.value.trim() || null;

        if(!name){
          fb.textContent = 'Inserisci il nome cliente.';
          fb.className = 'feedback err';
          return;
        }

        try{
          fb.textContent = 'Creazione in corso‚Ä¶';
          fb.className = 'feedback';
          await postJSON('/admin/clients', { name, email });
          fb.textContent = 'Cliente creato correttamente.';
          fb.className = 'feedback ok';

          // Se clients.js espone una funzione di reload, usala; altrimenti ricarica la pagina.
          if (typeof window.reloadClients === 'function') {
            await window.reloadClients();
            closeDialog();
          } else {
            setTimeout(()=>location.reload(), 400);
          }
        } catch(err){
          fb.textContent = 'Creazione non riuscita: ' + err.message;
          fb.className = 'feedback err';
        }
      }

      openBtn?.addEventListener('click', openDialog);
      cancelBtn?.addEventListener('click', closeDialog);
      form?.addEventListener('submit', onSubmit);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && dlg.open) closeDialog(); });
    })();
  </script>
</body>
</html>
<!-- touch -->
