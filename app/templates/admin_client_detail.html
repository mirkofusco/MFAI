<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <title>MF.AI ‚Äî Clienti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    .muted{color:#666}
    table pre{margin:0}
    dialog{max-width:520px}
    .feedback{margin-top:.5rem;font-size:.9rem;color:#666}
    .feedback.ok{color:#1b8a5a}
    .feedback.err{color:#c0392b}
  </style>
</head>
<body class="container">
  <header>
    <h2>MF.AI ‚Äî Clienti</h2>
    <p class="muted">Clicca su un cliente per aprire la sua scheda.</p>
    <nav>
      <a href="/ui" role="button" class="secondary">‚Üê Home Admin</a>
      <a href="/ui/prompts-ui" role="button">Prompts</a>
      <!-- üîò Nuovo: bottone per aggiungere clienti -->
      <button id="btn-open-new" class="contrast" style="margin-left:.5rem">+ Nuovo cliente</button>
    </nav>
  </header>

  <main>
    <article>
      <div id="list">Caricamento‚Ä¶</div>
    </article>
  </main>

  <!-- Modale: Nuovo cliente -->
  <dialog id="dlg-new">
    <article>
      <header>
        <strong>Crea nuovo cliente</strong>
      </header>
      <form id="form-new">
        <label>
          Nome <span style="color:#c00">*</span>
          <input type="text" id="nc-name" name="name" placeholder="Es. Acme srl" required>
        </label>

        <label>
          Email
          <input type="email" id="nc-email" name="email" placeholder="contatti@azienda.it">
        </label>

        <p id="nc-feedback" class="feedback" aria-live="polite"></p>

        <footer style="display:flex;justify-content:flex-end;gap:.5rem">
          <button type="button" class="secondary" id="btn-cancel">Annulla</button>
          <button type="submit">Crea</button>
        </footer>
      </form>
    </article>
  </dialog>

  <script src="/static/clients.js"></script>
  <script>
    (function(){
      const dlg = document.getElementById('dlg-new');
      const openBtn = document.getElementById('btn-open-new');
      const cancelBtn = document.getElementById('btn-cancel');
      const form = document.getElementById('form-new');
      const fb = document.getElementById('nc-feedback');
      const nameEl = document.getElementById('nc-name');
      const emailEl = document.getElementById('nc-email');

      function openDialog(){
        fb.textContent = ''; fb.className = 'feedback';
        form.reset();
        dlg.showModal();
        nameEl.focus();
      }
      function closeDialog(){
        dlg.close();
      }

      async function postJSON(url, data){
        const res = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          credentials: 'include',
          body: JSON.stringify(data)
        });
        if(!res.ok){
          let msg = 'Errore';
          try { const j = await res.json(); msg = j.error || msg; } catch {}
          throw new Error(msg + ' (HTTP ' + res.status + ')');
        }
        return res.json();
      }

      async function onSubmit(ev){
        ev.preventDefault();
        const name = nameEl.value.trim();
        const email = emailEl.value.trim() || null;

        if(!name){
          fb.textContent = 'Inserisci il nome cliente.';
          fb.className = 'feedback err';
          return;
        }

        try{
          fb.textContent = 'Creazione in corso‚Ä¶';
          fb.className = 'feedback';
          await postJSON('/admin/clients', { name, email });
          fb.textContent = 'Cliente creato correttamente.';
          fb.className = 'feedback ok';

          // Se clients.js espone una funzione di reload, usala; altrimenti ricarica la pagina.
          if (typeof window.reloadClients === 'function') {
            await window.reloadClients();
            closeDialog();
          } else {
            setTimeout(()=>location.reload(), 400);
          }
        } catch(err){
          fb.textContent = 'Creazione non riuscita: ' + err.message;
          fb.className = 'feedback err';
        }
      }

      openBtn?.addEventListener('click', openDialog);
      cancelBtn?.addEventListener('click', closeDialog);
      form?.addEventListener('submit', onSubmit);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && dlg.open) closeDialog(); });
    })();
  </script>
</body>
</html>
<!-- touch -->
